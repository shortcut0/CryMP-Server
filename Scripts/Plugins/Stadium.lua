eServerStat_StadiumPlayers = "stadium_players"

ServerStadium = {

    Config = {
        GoalPoints = 2,
    },

    Data = {
        Balls = {
            { Model = "objects/library/architecture/aircraftcarrier/props/misc/golfball.cgf", Pos = { x = -60.671508789062, y = 86.355834960938, z = -21.896484375 }, Dir = { x = 1.1644328834493e-09, y = -4.0531158447266e-06, z = 1.164437546386e-09 }, Scale = 15 },
        },
        Stadium = {
            { Model = "Objects/library/props/flags/northkorean_flagpole_a.cgf", 						Pos = { x = -84.671508789062, y = 35.042114257812, z = -28.609283447266 }, 	Dir = { x = 0, y = 0, z = 3.1415901184082 }, 					Scale = 1 },
            { Model = "Objects/Library/props/flags/american_flagpole_a.cgf", 							Pos = { x = -84.671508789062, y = 137.66955566406, z = -28.609283447266 }, 	Dir = { x = 0, y = 0, z = 0 }, 								Scale = 1 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -52.671508789062, y = 142.26953125,    z = -17.209289550781 }, 	Dir = { x = -1.570799946785, y = 0, z = 3.1415901184082 }, Scale = 	4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -52.671508789062, y = 142.26953125,    z = -33.209289550781 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 	4 },
            { Model = "objects/library/architecture/concrete structure/concrete_block_edge_8m.cgf", 	Pos = { x = -69.201538085938, y = 28.43212890625,  z = -16.75927734375 },   Dir = { x = 0, y = 0, z = 0 }, 								Scale = 1.0650000572205 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -52.671508789062, y = 30.442138671875, z = -17.209289550781 }, 	Dir = { x = 0, y = 1.5707963705063, z = 1.570799946785 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -68.671508789062, y = 142.26953125,    z = -17.209289550781 }, 	Dir = { x = 0, y = 1.5707963705063, z = -1.570799946785 }, Scale = 4 },
            { Model = "Objects/Library/Architecture/aircraftcarrier/pillars/pillar_25x275z.cgf", 		Pos = { x = -60.671508789062, y = 86.355834960938, z = -29.108276367188 }, 	Dir = { x = 0, y = 0, z = 0 }, Scale = 2 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a_corner.cgf", 				Pos = { x = -52.671508789062, y = 35.042114257812, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 0 }, Scale = 4 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.685180664062, y = 99.855834960938, z = -23.642272949219 }, 	Dir = { x = 0, y = -1.5707963705063, z = 3.1415901184082 }, Scale = 3.375 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a_end.cgf", 					Pos = { x = -52.671508789062, y = 137.66955566406, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 3.1415901184082 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -25.357788085938, y = 62.355834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a_corner.cgf", 				Pos = { x = -95.985229492188, y = 62.355834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = -1.570799946785 }, Scale = 4 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.657836914062, y = 72.855834960938, z = -23.642272949219 }, 	Dir = { x = 0, y = -1.5707963705063, z = 0 }, Scale = 3.375 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a_corner.cgf", 				Pos = { x = -25.357788085938, y = 110.35583496094, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 4 },
            { Model = "objects/library/architecture/concrete structure/concrete_block_edge_8m.cgf", 	Pos = { x = -52.671508789062, y = 30.442138671875, z = -17.209289550781 }, 	Dir = { x = 0, y = 0, z = 3.1415901184082 }, Scale = 1.0099999904633 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.657836914062, y = 46.355834960938, z = -23.642272949219 }, 	Dir = { x = 0, y = -1.5707963705063, z = 0 }, Scale = 3.375 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -68.671508789062, y = 30.442138671875, z = -33.209289550781 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 },Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a_corner.cgf", 				Pos = { x = -68.671508789062, y = 137.66955566406, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 3.1415901184082 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -95.985229492188, y = 78.355834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = -1.570799946785 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -95.985229492188, y = 94.355834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = -1.570799946785 }, Scale = 4 },
            { Model = "objects/library/architecture/concrete structure/concrete_block_edge_8m.cgf", 	Pos = { x = -68.671508789062, y = 142.26953125,    z = -17.209289550781 }, 	Dir = { x = 0, y = 0, z = 0 }, Scale = 1.0099999904633 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a_end.cgf", 					Pos = { x = -68.671508789062, y = 35.042114257812, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 0 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -25.357788085938, y = 94.355834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 4 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -95.985229492188, y = 110.35583496094, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = -1.570799946785 }, Scale = 4 },
            { Model = "objects/library/architecture/airfield/terminal_building/int_floor14.cgf", 		Pos = { x = -34.173461914062, y = 126.58581542969, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 5 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -25.357788085938, y = 78.355834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 4 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.933227539062, y = 46.545776367188, z = -12.849273681641 }, 	Dir = { x = 0, y = -1.5707963705063, z = -2.3561899662018 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.685180664062, y = 73.355834960938, z = -23.642272949219 }, 	Dir = { x = 0, y = -1.5707963705063, z = 3.1415901184082 }, Scale = 3.375 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.940185546875, y = 126.16589355469, z = -7.3692932128906 }, 	Dir = { x = 0, y = 1.5707963705063, z = -0.78540009260178 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.933227539062, y = 46.545776367188, z = -23.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = -2.3561899662018 }, Scale = 2.0299999713898 },
            { Model = "Objects/library/props/flags/northkorean_flagpole_a.cgf", 						Pos = { x = -36.671508789062, y = 35.042114257812, z = -28.609283447266 }, 	Dir = { x = 0, y = 0, z = 3.1415901184082 }, Scale = 1 },
            { Model = "objects/library/barriers/fence/concrete/school_wall_a.cgf", 						Pos = { x = -68.671508789062, y = 30.442138671875, z = -17.209289550781 }, 	Dir = { x = -1.570799946785, y = 0, z = 0 }, Scale = 4 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.409790039062, y = 126.16589355469, z = -12.849273681641 }, 	Dir = { x = 0, y = -1.5707963705063, z = 0.7853981256485 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.409790039062, y = 126.16589355469, z = -23.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = 0.7853981256485 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -36.671508789062, y = 137.56958007812, z = -12.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -68.671508789062, y = 35.14208984375,  z = -17.209289550781 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -52.671508789062, y = 35.14208984375,  z = -12.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -52.671508789062, y = 35.14208984375,  z = -23.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.657836914062, y = 99.355834960938, z = -23.642272949219 }, 	Dir = { x = 0, y = -1.5707963705063, z = 0 }, Scale = 3.375 },
            { Model = "Objects/Library/props/flags/american_flagpole_a.cgf", 							Pos = { x = -36.671508789062, y = 137.66955566406, z = -28.609283447266 }, 	Dir = { x = 0, y = 0, z = 0 }, Scale = 1 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.940185546875, y = 126.16589355469, z = 3.4407348632812 }, 	Dir = { x = 0, y = 1.5707963705063, z = -0.78540009260178 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.40283203125, y = 46.545776367188,  z = -7.3692932128906 }, 	Dir = { x = 0, y = 1.5707963705063, z = 2.3561973571777 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.40283203125, y = 46.545776367188,  z = 3.4407348632812 },   Dir = { x = 0, y = 1.5707963705063, z = 2.3561973571777 }, Scale = 2.0299999713898 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -96.118530273438, y = 137.83288574219, z = 2.335693359375 }, 	Dir = { x = 3.1415901184082, y = 0, z = 0 }, Scale = 8.8339996337891 },
            { Model = "objects/library/architecture/airfield/terminal_building/int_floor14.cgf", 		Pos = { x = -70.921508789062, y = 47.125854492188, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 5 },
            { Model = "objects/library/architecture/airfield/terminal_building/int_floor14.cgf", 		Pos = { x = -70.921508789062, y = 86.855834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 5 },
            { Model = "objects/library/architecture/airfield/terminal_building/int_floor14.cgf", 		Pos = { x = -34.173461914062, y = 47.125854492188, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 5 },
            { Model = "objects/library/architecture/airfield/terminal_building/int_floor14.cgf", 		Pos = { x = -70.921508789062, y = 126.58581542969, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 5 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -36.671508789062, y = 137.56958007812, z = -23.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -68.671508789062, y = 137.56958007812, z = -12.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -52.671508789062, y = 137.56958007812, z = -12.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -52.671508789062, y = 137.56958007812, z = -17.209289550781 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -84.671508789062, y = 35.14208984375,  z = -23.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -68.671508789062, y = 35.14208984375,  z = -12.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -95.685180664062, y = 126.35583496094, z = -23.642272949219 }, 	Dir = { x = 0, y = -1.5707963705063, z = 3.1415901184082 }, Scale = 3.375 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -25.224487304688, y = 34.878784179688, z = 2.335693359375 }, 	Dir = { x = 3.1415901184082, y = 0, z = 3.1415901184082 }, Scale = 8.8339996337891 },
            { Model = "objects/library/architecture/concrete structure/concrete_block_edge_8m.cgf", 	Pos = { x = -52.141479492188, y = 144.27954101562, z = -16.75927734375 }, 	Dir = { x = 0, y = 0, z = 3.1415901184082 }, Scale = 1.0650000572205 },
            { Model = "objects/library/architecture/airfield/terminal_building/int_floor14.cgf", 		Pos = { x = -34.173461914062, y = 86.855834960938, z = -23.609283447266 }, 	Dir = { x = 0, y = 0, z = 1.570799946785 }, Scale = 5 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -68.671508789062, y = 137.56958007812, z = -23.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = 1.570799946785 }, Scale = 2 },
            { Model = "objects/library/architecture/aircraftcarrier/ceilings/ceiling_800x800y.cgf", 	Pos = { x = -84.671508789062, y = 35.14208984375,  z = -12.609283447266 }, 	Dir = { x = 0, y = -1.5707963705063, z = -1.570799946785 }, Scale = 2 },
        }
    },

    ------------
    Temp = (ServerStadium and ServerStadium.Temp or {
        Active = false,

        BBoxes = {
            Stadium = {
                min = { x = -97, x = 27, z = -30 },
                max = { x = -25, y = 145, z = 20}
            },
            Gates = {
                [TEAM_NK] = {
                    min = { x = -69, y = 30, z = -30 },
                    max = { x = -53, y = 36, z = -20 }
                },
                [TEAM_US] = {
                    min = { x = -69, y = 136, z = -30 },
                    max = { x = -53, y = 142, z = -20 }
                }
            }
        },

        Parts = {},
        Balls = {},

        EndTimer = timernew(60),
    }),

    --------------------
    Init = function(self)

        LinkEvent(eServerEvent_OnClientInit,   "ServerStadium", self.InitClient)
        LinkEvent(eServerEvent_ScriptTickFast, "ServerStadium", self.Tick)
    end,

    --------------------
    InitClient = function(self, hClient)

        table.checkM(hClient, "StadiumInfo", {

            Playing = false,
            TeamID  = nil,
            Goals   = 0,
            TopGoal = -1,
        })

        hClient:AddInstantRevive("Stadium", function(this)
            return (this.StadiumInfo.Playing == true)
        end)

        hClient:AddSpawnLocation("Stadium", {
            OnUsed = function(hPlayer)
                ServerStadium:OnEntered(hPlayer, hPlayer.StadiumInfo.TeamID)
            end,
            Check = function(this, hPlayer)
                local hID = hPlayer.StadiumInfo.Playing
                if (hID) then
                    local vPos, vDir = ServerStadium:GetSpawnLocation(hPlayer, hPlayer.StadiumInfo.TeamID)
                    this.Pos = vPos
                    this.Dir = vDir
                end
                return hID == true
            end,
            Priority = 1,
            Pos      = nil,
            Dir      = nil,
        })
    end,

    ------------
    Exists = function(self, bCheckAll)

        local bOk = true
        for _, hPart in pairs(self.Temp.Parts) do
            bOk = (bOk and GetEntity(hPart.id) ~= nil)
            if (not bOk) then
                break
            end
        end
        if (bCheckAll) then
            for _, hBall in pairs(self.Temp.Balls) do
                bOk = (bOk and GetEntity(hBall.id) ~= nil)
                if (not bOk) then
                    break
                end
            end
        end

        return bOk
    end,

    ------------
    Delete = function(self)

        for _, hPart in pairs(self.Temp.Parts) do
            System.RemoveEntity(hPart.id)
        end

        for _, hPart in pairs(self.Temp.Balls) do
            System.RemoveEntity(hPart.id)
        end

        self.Temp.Parts = {}
    end,

    ------------
    Reset = function(self)

        self.Temp.Active = false
        self.Temp.EndTimer.refresh()
        self.Temp.Restarting = false
        self.Temp.Goals  = { [TEAM_NK] = 0, [TEAM_US] = 0 }
    end,

    ------------
    Remove = function(self, hAdmin)

        if (not self.Temp.Active) then
            return false, "dont exist"
        end

        for _, hPlayer in pairs(GetPlayers()) do
            if (hPlayer.StadiumInfo.Playing) then
                self:Leave(hPlayer, true)
            end
        end

        self:Reset()
        self:Delete()

        SendMsg(CHAT_STADIUM, ALL, "@l_ui_stadiumRemoved")
    end,

    ------------
    Create = function(self, hAdmin)

        if (self.Temp.Active) then
            return false, "exists"
        end

        self:Spawn()
        SendMsg(CHAT_STADIUM, ALL, "@l_ui_stadiumSpawned")
    end,

    ------------
    Spawn = function(self)

        ------------
        if (self:Exists()) then
            self:Delete()
        end

        ------------
        local vPos = {
            x = 500,
            y = 500,
            z = 1000
        }

        self:Reset()

        local sClass = "GUI"
        local iScale = 1.0

        self.Temp.BBoxes.Stadium = {
            min = vector.scaleInPlace({ x = -97, y = 27, z = -30 }, iScale),
            max = vector.scaleInPlace({ x = -25, y = 145, z = 20 }, iScale),
        }

        self.Temp.BBoxes.Stadium.min = vector.addInPlace(self.Temp.BBoxes.Stadium.min, vPos)
        self.Temp.BBoxes.Stadium.max = vector.addInPlace(self.Temp.BBoxes.Stadium.max, vPos)

        self.Temp.BBoxes.Gates = {
            [TEAM_NK] = {
                min = vector.scaleInPlace({ x = -69, y = 30, z = -30 }, iScale),
                max = vector.scaleInPlace({ x = -53, y = 36, z = -20 }, iScale),
            },
            [TEAM_US] = {
                min = vector.scaleInPlace({ x = -69, y = 136, z = -30 }, iScale),
                max = vector.scaleInPlace({ x = -53, y = 142, z = -20 }, iScale),
            }
        }

        self.Temp.BBoxes.Gates[TEAM_NK].min = vector.addInPlace(self.Temp.BBoxes.Gates[TEAM_NK].min, vPos)
        self.Temp.BBoxes.Gates[TEAM_NK].max = vector.addInPlace(self.Temp.BBoxes.Gates[TEAM_NK].max, vPos)

        self.Temp.BBoxes.Gates[TEAM_US].min = vector.addInPlace(self.Temp.BBoxes.Gates[TEAM_US].min, vPos)
        self.Temp.BBoxes.Gates[TEAM_US].max = vector.addInPlace(self.Temp.BBoxes.Gates[TEAM_US].max, vPos)

        for _, aPart in pairs(self.Data.Stadium) do
            self.Temp.Parts[_] = SpawnGUI({

                Model   = aPart.Model,
                Pos     = vector.addInPlace(vPos, vector.scaleInPlace(aPart.Pos, iScale)),
                Ang     = (aPart.Dir),
                Physics = true,
                Rigid   = false,
                Mass    = -1,
                Resting = true,
                Scale   = (iScale * (aPart.Scale or 0)),
                Network = true
            })

            self.Temp.Parts[_]:SetAngles(aPart.Dir)
        end

        ------------
        for _, aBall in pairs(self.Data.Balls) do
            self.Temp.Balls[_] = SpawnGUI({

                Model   = aBall.Model,
                Pos     = vector.addInPlace(vPos, vector.scaleInPlace(aBall.Pos, iScale)),
                Dir     = aBall.Dir,
                Physics = true,
                Rigid   = true,
                Mass    = 1,
                Resting = false,
                Scale   = (iScale * (aBall.Scale or 0)),
                Network = true
            })

            -- For Resetting!
            self.Temp.Balls[_].SpawnPosition      = self.Temp.Balls[_]:GetPos()
            self.Temp.Balls[_].SvReportCollisions = true

            self.Temp.Balls[_].SvOnCollision = function(this, hEntity)
                if (hEntity and hEntity.IsPlayer) then
                  --  Debug("coll!")
                    local iSpeed = hEntity:GetSpeed()
                    local fImpulse = (iSpeed * 10)
                    this:AddImpulse(-1, this:GetCenterOfMassPos(), hEntity:SmartGetDir(), fImpulse, 1)
                    Debug(fImpulse)
                end
            end
        end

        self.Temp.Active   = true
        self.Temp.Position      = vPos
        self.Temp.SpawnPosition = vPos
        self.Temp.GroundOffSet  = vPos.z - 24

        return true

    end,

    ------------
    OnEntered = function(self, hPlayer)

        AddServerStat(eServerStat_StadiumPlayers, 1)
        SendMsg(CHAT_STADIUM_LOCALE, ALL, "@l_ui_joinedStadium", GetServerStat(eServerStat_StadiumPlayers), hPlayer:GetName(), GetTeamName(hPlayer.StadiumInfo.TeamID))
    end,

    ------------
    OnLeft = function(self, hPlayer)

        SendMsg(CHAT_STADIUM_LOCALE, ALL, "@l_ui_leftStadium", hPlayer:GetName())
    end,

    ------------
    GetWeakerTeam = function(self)

        local iNK = 0
        local iUS = 0
        for _, hPlayer in pairs(GetPlayers()) do
            if (hPlayer.StadiumInfo.Playing) then
                local iTeam = hPlayer.StadiumInfo.TeamID
                if (iTeam == TEAM_NK) then
                    iNK = (iNK + 1)
                else
                    iUS = (iUS + 1)
                end
            end
        end

        return (iUS > iNK and TEAM_NK or TEAM_US)
    end,

    ------------
    Enter = function(self, hPlayer, hTeam)

        if (not self.Temp.Active) then
            return false, hPlayer:Localize("@l_ui_stadiumNotSpawned")
        end

        local iTeam
        if (hTeam == nil) then
            iTeam = self:GetWeakerTeam()

        elseif (string.lower(hTeam) == "nk" or hTeam == "1" or hTeam == TEAM_NK) then
            iTeam = TEAM_NK

        elseif (string.lower(hTeam) == "us" or hTeam == "2" or hTeam == TEAM_US) then
            iTeam = TEAM_US

        else
            return false, hPlayer:Localize("@l_ui_invalidTeam")
        end

        hPlayer.StadiumInfo.Playing = true
        hPlayer.StadiumInfo.TeamID  = iTeam
        hPlayer.StadiumInfo.Goals   = 0
        hPlayer.StadiumInfo.TopGoal = -1

        self:OnEntered(hPlayer)
        self:Teleport(hPlayer)
    end,

    ------------
    Leave = function(self, hPlayer, bQuiet)

        if (not hPlayer.StadiumInfo.Playing) then
            return false, hPlayer:Localize("@l_ui_notInStadium")
        end

        hPlayer.StadiumInfo.Playing = false
        hPlayer.StadiumInfo.TeamID  = nil
        hPlayer.StadiumInfo.Goals   = nil
        hPlayer.StadiumInfo.TopGoal = nil

        if (not bQuiet) then
            self:OnLeft(hPlayer)
        end

        g_gameRules:RevivePlayer(hPlayer:GetChannel(), hPlayer, false)
    end,

    ------------
    Teleport = function(self, hPlayer, vPos)

        local iTeam = hPlayer.StadiumInfo.TeamID
        local vSpawn, vAng = self:GetSpawnLocation(hPlayer, iTeam)
        vSpawn = vPos or vSpawn

        hPlayer:SetEnergy(200)
        hPlayer:SvMoveTo(vSpawn, vAng)
    end,

    ------------
    ClosestBall = function(self, vPos)

        local aClosest = { -1, vPos }
        for _, hBall in pairs(self.Temp.Balls) do
            local iDistance = vector.distance(hBall:GetPos(), vPos)
            if (aClosest[1] == -1 or aClosest[1] > iDistance) then
                aClosest =  {
                    iDistance, hBall:GetPos()
                }
            end
        end

        return aClosest[2]
    end,

    ------------
    GetSpawnLocation = function(self, hPlayer, iTeam)

        iTeam = (iTeam or hPlayer.StadiumInfo.TeamID)
        Debug(iTeam)
        local aGate = self.Temp.BBoxes.Gates[iTeam]

        local vCenterDir
        local vCenter = vector.bbox_center(aGate, self.Temp.GroundOffSet)
        SpawnEffect(ePE_Flare,vCenter)

        vCenter.y = (vCenter.y + (12.5 * (iTeam == TEAM_US and -1 or 1)))

        local vSpawn  = vector.modifyx(vCenter, math.random(-20, 20))
        return vSpawn, vector.toang(vector.getdir(vSpawn, self:ClosestBall(vSpawn), 1, -1))
    end,

    ------------
    EndGame = function(self, iTeam)

        local aMVP = { 0, nil }
        for _, hPlayer in pairs(GetPlayers()) do
            local iPlayerGoals = hPlayer.StadiumInfo.Goals
            if (hPlayer.StadiumInfo.Playing and iPlayerGoals > aMVP[1]) then
                aMVP = { iPlayerGoals, hPlayer }
            end
        end

        local hMVP = aMVP[2]

        local iTeamGoals = self.Temp.Goals[iTeam]

        SendMsg(CHAT_STADIUM_LOCALE, ALL, "@l_ui_stadiumGameOver", GetTeamName(iTeam), iTeamGoals)
        if (hMVP) then
            SendMsg(CHAT_STADIUM_LOCALE, ALL, "@l_ui_stadiumMVP", hMVP:GetName(), aMVP[1])
        end

        self.Temp.Restarting = true
        self.Temp.EndTimer.refresh()
    end,

    ------------
    OnGoal = function(self, iTeam, iAdd, hRonaldo)

        local sBy = "Godly Forces"
        if (hRonaldo) then
            sBy = hRonaldo:GetName()
            hRonaldo.StadiumInfo.Goals = (hRonaldo.StadiumInfo.Goals + 1)
        end

        self.Temp.Goals[iTeam] = (self.Temp.Goals[iTeam] + iAdd)

        local iOtherTeam    = GetOtherTeam(iTeam)
        local iOtherGoals   = self.Temp.Goals[iOtherTeam]
        local iGoals    = self.Temp.Goals[iTeam]
        local iDiff     = (iGoals - iOtherGoals)
        local sStatus   = "@l_ui_stadiumEqualPoints"

        if (iDiff > 0) then
            sStatus = string.format("They are ( #%d ) Ahead of %s", iDiff, GetTeamName(iOtherTeam))
            sStatus = "@l_ui_stadiumGreaterPoints"

        elseif (iDiff < 0) then
            sStatus = string.format("They are ( #%d ) Behind of %s", (iDiff * -1), GetTeamName(iOtherTeam))
            sStatus = "@l_ui_stadiumLesserPoints"
        end

        if (iGoals > self.Config.GoalPoints) then
            self:EndGame(iTeam)

        else

            for _, hPlayer in pairs(GetPlayers()) do
                SendMsg(CHAT_STADIUM_LOCALE, hPlayer, hPlayer:LocalizeNest("@l_ui_stadiumGoal", { sBy, iAdd, GetTeamName(iTeam), sStatus }, { math.abs(iDiff), GetTeamName(iOtherTeam) }))
                --SendMsg(CHAT_STADIUM_LOCALE, ALL, string.format("(%s: Scored - ( #%d ) - Points for %s (%s))", sBy, iAdd, GetTeamName(iTeam), sStatus))
            end
            --SendMsg(CHAT_STADIUM_LOCALE, ALL, string.format("(%s: Scored - ( #%d ) - Points for %s (%s))", sBy, iAdd, GetTeamName(iTeam), sStatus))

        end
    end,

    ------------
    InsideGoal = function(self, hBall)

        local aNK_BBox = self.Temp.BBoxes.Gates[TEAM_NK]
        local aUS_BBox = self.Temp.BBoxes.Gates[TEAM_US]

        local vBall = hBall:GetPos()

        local bInNK = vector.bbox_inside(aNK_BBox, vBall)
        local bInUS = vector.bbox_inside(aUS_BBox, vBall)

        local hPlayer = GetEntity(hBall.LastPlayerShooterId)
        if (not hPlayer or not hPlayer.StadiumInfo.Playing) then
            return false
        end

        local iLastTeam = hPlayer.StadiumInfo.TeamID --hBall.LastShooterTeam
        local sLastName = hPlayer:GetName()          --hBall.LastShooterName

        sLastName = (string.emptyN(sLastName) and "Godly Forces" or sLastName)

        if (iLastTeam ~= TEAM_NK and bInNK) then
            self:OnGoal(TEAM_US, 1, hPlayer)
            self:ResetBall(hBall)

        elseif (iLastTeam ~= TEAM_US and bInUS) then
            self:OnGoal(TEAM_NK, 1, hPlayer)
            self:ResetBall(hBall)
        end

        if (bInNK or bInUS) then
            return true
        end
    end,

    ------------
    GetPlayers = function(self)

        return table.it(GetPlayers(), function(x, i, v) x = x or {} if (v.StadiumInfo.Playing) then table.insert(x, v) end return x end)
    end,

    ------------
    Tick = function(self)

        ------------
        if (not self.Temp.Active) then
            return
        elseif (not self:Exists(true)) then
            self:Spawn()
        end

        for _, hBall in pairs(self.Temp.Balls) do
            if (not vector.bbox_inside(self.Temp.BBoxes.Stadium, hBall:GetPos())) then
                self:ResetBall(hBall)
            end

            if (not self.Temp.Restarting and self:InsideGoal(hBall)) then
            end
        end

        if (self.Temp.Restarting) then
            if (self.Temp.EndTimer.expired(15)) then
                self:Reset() self.Temp.Active = true
                for _, hBall in pairs(self.Temp.Balls) do
                    self:ResetBall(hBall)
                end
                for _, hPlayer in pairs(self:GetPlayers()) do
                    self:Teleport(hPlayer)
                end
            else
                SendMsg(MSG_CENTER, self:GetPlayers(), "@l_ui_stadiumRestarting", math.floor(self.Temp.EndTimer.getexpiry()))
            end


        else
        end

        for _, hPlayer in pairs(GetPlayers()) do

            if (hPlayer.StadiumInfo.Playing) then
                if (hPlayer:IsSpectating()) then

                else

                    if (self.Temp.Restarting) then
                        self:ArmPlayer(hPlayer)
                    else
                        self:Disarm(hPlayer)
                        g_pGame:SetInvulnerability(hPlayer.id, true, 1)
                    end
                    local vPos = hPlayer:GetPos()
                    if (not vector.bbox_inside(self.Temp.BBoxes.Stadium, vPos)) then
                        self:Teleport(hPlayer, (hPlayer.StadiumInfo.LastInside or self:GetSpawnLocation(hPlayer)))
                    else
                        hPlayer.StadiumInfo.LastInside = vPos
                    end
                end
            end
        end

    end,

    ------------
    ArmPlayer = function(self, hPlayer)

        local iNumItems = table.count(hPlayer.inventory:GetInventoryTable())
        if (iNumItems == 3 or not hPlayer.StadiumInfo.Armed) then
            g_gameRules:EquipPlayer(hPlayer)
        end

        hPlayer.StadiumInfo.Armed = true
    end,

    ------------
    Disarm = function(self, hPlayer)

        local iNumItems = table.count(hPlayer.inventory:GetInventoryTable())
        if (iNumItems > 3) then
            --hPlayer.inventory:Destroy()
            --[[Script.SetTimer(25, function()
                hPlayer:GiveItem("AlienCloak")
                hPlayer:GiveItem("OffHand")
                hPlayer:GiveItem("Fists")
                Script.SetTimer(100, function()
                    hPlayer:SelectItem("Fists")
                end)
            end)]]
        end

        local hCurr = hPlayer:GetCurrentItem()
        if (not hCurr or (hCurr.class ~= "Fists")) then

            if (not hCurr) then
                hPlayer:GiveItem("Fists")
            else
                System.RemoveEntity(hCurr.id)
            end
            Script.SetTimer(100, function()
                hPlayer:SelectItem("Fists")
            end)
        end

        hPlayer.StadiumInfo.Armed = false
    end,

    ------------
    ResetBall = function(self, hBall)

        local vPos = vector.modifyz(hBall.SpawnPosition, 15)

        hBall:SetWorldPos(vPos)
        ServerUtils.AwakeEntity(hBall.id)
        SpawnEffect(ePE_Light, vPos, g_Vectors.up, 0.5)
    end,

}

ServerStadium:Init()